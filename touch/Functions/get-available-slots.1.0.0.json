{
  "key": "get-available-slots",
  "flow": "sys-functions",
  "domain": "touch",
  "version": "1.0.0",
  "flowVersion": "1.0.0",
  "tags": [
    "appointments",
    "availability",
    "slots",
    "advisor",
    "calendar"
  ],
  "attributes": {
    "scope": "I",
    "task": {
      "order": 1,
      "task": {
        "key": "get-available-slots-task",
        "domain": "touch",
        "version": "1.0.0",
        "flow": "sys-tasks"
      },
      "mapping": {
        "location": "./src/GetAvailableSlotsMapping.csx",
        "code": "dXNpbmcgU3lzdGVtOwp1c2luZyBTeXN0ZW0uQ29sbGVjdGlvbnMuR2VuZXJpYzsKdXNpbmcgU3lzdGVtLkxpbnE7CnVzaW5nIFN5c3RlbS5UaHJlYWRpbmcuVGFza3M7CnVzaW5nIEJCVC5Xb3JrZmxvdy5TY3JpcHRpbmc7CnVzaW5nIEJCVC5Xb3JrZmxvdy5EZWZpbml0aW9uczsKCi8vLyA8c3VtbWFyeT4KLy8vIE1hcHBpbmcgZm9yIEdldEF2YWlsYWJsZVNsb3RzVGFzayAoRGFwclNlcnZpY2VUYXNrIC0gVHlwZSAzKQovLy8gUXVlcmllcyBhYnNlbmNlLWVudHJ5IHdvcmtmbG93IHZpYSBEYXByIHNlcnZpY2UgaW52b2NhdGlvbiB0byBnZXQgcHVibGljIGhvbGlkYXlzLCAKLy8vIHdvcmtpbmcgaG91cnMgY2hhbmdlcywgYW5kIHBlcnNvbmFsIGxlYXZlcy4KLy8vIFRoZW4gY2FsY3VsYXRlcyBhdmFpbGFibGUgYXBwb2ludG1lbnQgc2xvdHMgZm9yIHRoZSBnaXZlbiBhZHZpc29yIGFuZCBkYXRlLgovLy8gCi8vLyBSZWZlcmVuY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9idXJnYW4tdGVjaC92bmV4dC1ydW50aW1lL2Jsb2IvbWFpbi9kb2MvZW4vZmxvdy90YXNrcy9kYXByLXNlcnZpY2UubWQKLy8vIDwvc3VtbWFyeT4KcHVibGljIGNsYXNzIEdldEF2YWlsYWJsZVNsb3RzTWFwcGluZyA6IFNjcmlwdEJhc2UsIElNYXBwaW5nCnsKICAgIHByaXZhdGUgY29uc3QgaW50IERlZmF1bHRBcHBvaW50bWVudER1cmF0aW9uID0gMzA7IC8vIG1pbnV0ZXMKCiAgICBwdWJsaWMgVGFzazxTY3JpcHRSZXNwb25zZT4gSW5wdXRIYW5kbGVyKFdvcmtmbG93VGFzayB0YXNrLCBTY3JpcHRDb250ZXh0IGNvbnRleHQpCiAgICB7CiAgICAgICAgdHJ5CiAgICAgICAgewogICAgICAgICAgICB2YXIgc2VydmljZVRhc2sgPSB0YXNrIGFzIERhcHJTZXJ2aWNlVGFzazsKICAgICAgICAgICAgaWYgKHNlcnZpY2VUYXNrID09IG51bGwpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZE9wZXJhdGlvbkV4Y2VwdGlvbigiVGFzayBtdXN0IGJlIGEgRGFwclNlcnZpY2VUYXNrIik7CgogICAgICAgICAgICAvLyBSZWFkIHBhcmFtZXRlcnMgZnJvbSBxdWVyeSBzdHJpbmcgKEdFVCByZXF1ZXN0KQogICAgICAgICAgICB2YXIgYWR2aXNvcklkID0gY29udGV4dC5RdWVyeVBhcmFtZXRlcnM/WyJhZHZpc29ySWQiXT8uVG9TdHJpbmcoKTsKICAgICAgICAgICAgdmFyIGRhdGUgPSBjb250ZXh0LlF1ZXJ5UGFyYW1ldGVycz9bImRhdGUiXT8uVG9TdHJpbmcoKTsKICAgICAgICAgICAgdmFyIGR1cmF0aW9uU3RyID0gY29udGV4dC5RdWVyeVBhcmFtZXRlcnM/WyJkdXJhdGlvbiJdPy5Ub1N0cmluZygpOwoKICAgICAgICAgICAgaWYgKHN0cmluZy5Jc051bGxPckVtcHR5KGFkdmlzb3JJZCkgfHwgc3RyaW5nLklzTnVsbE9yRW1wdHkoZGF0ZSkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiBUYXNrLkZyb21SZXN1bHQobmV3IFNjcmlwdFJlc3BvbnNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgS2V5ID0gInZhbGlkYXRpb24tZXJyb3IiLAogICAgICAgICAgICAgICAgICAgIERhdGEgPSBuZXcgeyAKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IgPSAiYWR2aXNvcklkIGFuZCBkYXRlIGFyZSByZXF1aXJlZCIsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yQ29kZSA9ICJWQUxJREFUSU9OX0VSUk9SIgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDb25maWd1cmUgRGFwciBTZXJ2aWNlIFRhc2sKICAgICAgICAgICAgLy8gQXBwSWQgaXMgdGhlIHRhcmdldCBzZXJ2aWNlIG5hbWUgaW4gRGFwcgogICAgICAgICAgICBzZXJ2aWNlVGFzay5TZXRBcHBJZCgidm5leHQtYXBwIik7CiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQnVpbGQgcXVlcnkgc3RyaW5nIGZvciBmaWx0ZXJpbmcKICAgICAgICAgICAgdmFyIHF1ZXJ5UGFyYW1zID0gbmV3IExpc3Q8c3RyaW5nPgogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAic3RhdHVzPUFjdGl2ZSIsCiAgICAgICAgICAgICAgICAiY3VycmVudFN0YXRlPXNjaGVkdWxlZCxhY3RpdmUiLAogICAgICAgICAgICAgICAgInBhZ2VTaXplPTEwMCIKICAgICAgICAgICAgfTsKICAgICAgICAgICAgc2VydmljZVRhc2suU2V0UXVlcnlTdHJpbmcoc3RyaW5nLkpvaW4oIiYiLCBxdWVyeVBhcmFtcykpOwoKICAgICAgICAgICAgcmV0dXJuIFRhc2suRnJvbVJlc3VsdChuZXcgU2NyaXB0UmVzcG9uc2UoKSk7CiAgICAgICAgfQogICAgICAgIGNhdGNoIChFeGNlcHRpb24gZXgpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gVGFzay5Gcm9tUmVzdWx0KG5ldyBTY3JpcHRSZXNwb25zZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBLZXkgPSAiaW5wdXQtZXJyb3IiLAogICAgICAgICAgICAgICAgRGF0YSA9IG5ldyB7IAogICAgICAgICAgICAgICAgICAgIGVycm9yID0gZXguTWVzc2FnZSwKICAgICAgICAgICAgICAgICAgICBlcnJvckNvZGUgPSAiSU5QVVRfRVJST1IiCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICBwdWJsaWMgYXN5bmMgVGFzazxTY3JpcHRSZXNwb25zZT4gT3V0cHV0SGFuZGxlcihTY3JpcHRDb250ZXh0IGNvbnRleHQpCiAgICB7CiAgICAgICAgdHJ5CiAgICAgICAgewogICAgICAgICAgICAvLyBSZWFkIHBhcmFtZXRlcnMgZnJvbSBxdWVyeSBzdHJpbmcgKEdFVCByZXF1ZXN0KQogICAgICAgICAgICB2YXIgYWR2aXNvcklkID0gY29udGV4dC5RdWVyeVBhcmFtZXRlcnM/WyJhZHZpc29ySWQiXT8uVG9TdHJpbmcoKTsKICAgICAgICAgICAgdmFyIGRhdGVTdHIgPSBjb250ZXh0LlF1ZXJ5UGFyYW1ldGVycz9bImRhdGUiXT8uVG9TdHJpbmcoKTsKICAgICAgICAgICAgdmFyIGR1cmF0aW9uU3RyID0gY29udGV4dC5RdWVyeVBhcmFtZXRlcnM/WyJkdXJhdGlvbiJdPy5Ub1N0cmluZygpOwogICAgICAgICAgICB2YXIgZHVyYXRpb24gPSBzdHJpbmcuSXNOdWxsT3JFbXB0eShkdXJhdGlvblN0cikgPyBEZWZhdWx0QXBwb2ludG1lbnREdXJhdGlvbiA6IGludC5QYXJzZShkdXJhdGlvblN0cik7CgogICAgICAgICAgICAvLyBWYWxpZGF0aW9uCiAgICAgICAgICAgIGlmIChzdHJpbmcuSXNOdWxsT3JFbXB0eShhZHZpc29ySWQpIHx8IHN0cmluZy5Jc051bGxPckVtcHR5KGRhdGVTdHIpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFNjcmlwdFJlc3BvbnNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgS2V5ID0gInZhbGlkYXRpb24tZXJyb3IiLAogICAgICAgICAgICAgICAgICAgIERhdGEgPSBuZXcKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yID0gImFkdmlzb3JJZCBhbmQgZGF0ZSBhcmUgcmVxdWlyZWQiLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvckNvZGUgPSAiVkFMSURBVElPTl9FUlJPUiIsCiAgICAgICAgICAgICAgICAgICAgICAgIGFkdmlzb3JJZCwKICAgICAgICAgICAgICAgICAgICAgICAgZGF0ZSA9IGRhdGVTdHIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBQYXJzZSBkYXRlIC0gZXhwZWN0aW5nICJ5eXl5LU1NLWRkIiBmb3JtYXQKICAgICAgICAgICAgdmFyIHJlcXVlc3RlZERhdGUgPSBEYXRlVGltZS5QYXJzZShkYXRlU3RyKTsKICAgICAgICAgICAgdmFyIGRheU9mV2VlayA9IHJlcXVlc3RlZERhdGUuRGF5T2ZXZWVrLlRvU3RyaW5nKCkuVG9Mb3dlcigpOwoKICAgICAgICAgICAgLy8gR2V0IERhcHIgU2VydmljZSByZXNwb25zZQogICAgICAgICAgICB2YXIgcmVzcG9uc2UgPSBjb250ZXh0LkJvZHk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBDaGVjayBpZiBzZXJ2aWNlIGNhbGwgd2FzIHN1Y2Nlc3NmdWwKICAgICAgICAgICAgaWYgKHJlc3BvbnNlPy5pc1N1Y2Nlc3MgPT0gZmFsc2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvclR5cGUgPSBDbGFzc2lmeVNlcnZpY2VFcnJvcihyZXNwb25zZT8uZXJyb3JNZXNzYWdlPy5Ub1N0cmluZygpID8/ICIiKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBTY3JpcHRSZXNwb25zZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIEtleSA9ICJzZXJ2aWNlLWVycm9yIiwKICAgICAgICAgICAgICAgICAgICBEYXRhID0gbmV3CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBlcnJvciA9ICJGYWlsZWQgdG8gZmV0Y2ggYWJzZW5jZSBlbnRyaWVzIiwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JDb2RlID0gIlNFUlZJQ0VfRVJST1IiLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvclR5cGUgPSBlcnJvclR5cGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yTWVzc2FnZSA9IHJlc3BvbnNlPy5lcnJvck1lc3NhZ2U/LlRvU3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZpY2VJbmZvID0gbmV3CiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcElkID0gcmVzcG9uc2U/Lm1ldGFkYXRhPy5hcHBJZD8uVG9TdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZE5hbWUgPSByZXNwb25zZT8ubWV0YWRhdGE/Lm1ldGhvZE5hbWU/LlRvU3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBodHRwVmVyYiA9IHJlc3BvbnNlPy5tZXRhZGF0YT8uaHR0cFZlcmI/LlRvU3RyaW5nKCkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgVGFncyA9IG5ld1tdIHsgImFwcG9pbnRtZW50cyIsICJlcnJvciIgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gR2V0IGl0ZW1zIGZyb20gc2VydmljZSByZXNwb25zZQogICAgICAgICAgICAvLyBSZXNwb25zZSBzdHJ1Y3R1cmU6IHsgZGF0YTogeyBpdGVtczogWy4uLl0gfSwgaXNTdWNjZXNzOiB0cnVlLCAuLi4gfQogICAgICAgICAgICB2YXIgcmVzcG9uc2VEYXRhID0gcmVzcG9uc2U/LmRhdGE7CiAgICAgICAgICAgIHZhciBpdGVtcyA9IHJlc3BvbnNlRGF0YT8uaXRlbXM7CiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgaW5zdGFuY2VzID0gbmV3IExpc3Q8ZHluYW1pYz4oKTsKICAgICAgICAgICAgaWYgKGl0ZW1zICE9IG51bGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZvcmVhY2ggKHZhciBpdGVtIGluIGl0ZW1zKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGluc3RhbmNlcy5BZGQoaXRlbSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENhdGVnb3JpemUgaW5zdGFuY2VzCiAgICAgICAgICAgIHZhciBwdWJsaWNIb2xpZGF5cyA9IG5ldyBMaXN0PGR5bmFtaWM+KCk7CiAgICAgICAgICAgIHZhciB3b3JraW5nSG91cnNDaGFuZ2VzID0gbmV3IExpc3Q8ZHluYW1pYz4oKTsKICAgICAgICAgICAgdmFyIHBlcnNvbmFsTGVhdmVzID0gbmV3IExpc3Q8ZHluYW1pYz4oKTsKCiAgICAgICAgICAgIGZvcmVhY2ggKHZhciBpbnN0YW5jZSBpbiBpbnN0YW5jZXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIEluc3RhbmNlIHN0cnVjdHVyZTogeyBhdHRyaWJ1dGVzOiB7IGFic2VuY2VUeXBlLCBhZHZpc29yLCAuLi4gfSB9CiAgICAgICAgICAgICAgICB2YXIgYXR0cmlidXRlcyA9IGluc3RhbmNlPy5hdHRyaWJ1dGVzOwogICAgICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZXMgPT0gbnVsbCkgY29udGludWU7CgogICAgICAgICAgICAgICAgdmFyIGFic2VuY2VUeXBlID0gYXR0cmlidXRlcz8uYWJzZW5jZVR5cGU/LlRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICB2YXIgc2NvcGUgPSBhdHRyaWJ1dGVzPy5zY29wZT8uVG9TdHJpbmcoKTsKICAgICAgICAgICAgICAgIHZhciBhZHZpc29yID0gYXR0cmlidXRlcz8uYWR2aXNvcj8uVG9TdHJpbmcoKTsKCiAgICAgICAgICAgICAgICBzd2l0Y2ggKGFic2VuY2VUeXBlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGNhc2UgInB1YmxpYy1ob2xpZGF5IiB3aGVuIHNjb3BlID09ICJhbGwtYWR2aXNvcnMiOgogICAgICAgICAgICAgICAgICAgICAgICBwdWJsaWNIb2xpZGF5cy5BZGQoaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICJ3b3JraW5nLWhvdXJzLWNoYW5nZSIgd2hlbiBhZHZpc29yID09IGFkdmlzb3JJZDoKICAgICAgICAgICAgICAgICAgICAgICAgd29ya2luZ0hvdXJzQ2hhbmdlcy5BZGQoaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlICJwZXJzb25hbC1sZWF2ZSIgd2hlbiBhZHZpc29yID09IGFkdmlzb3JJZDoKICAgICAgICAgICAgICAgICAgICAgICAgcGVyc29uYWxMZWF2ZXMuQWRkKGluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIGZvciBwdWJsaWMgaG9saWRheQogICAgICAgICAgICB2YXIgaG9saWRheSA9IEZpbmRQdWJsaWNIb2xpZGF5KHB1YmxpY0hvbGlkYXlzLCByZXF1ZXN0ZWREYXRlKTsKICAgICAgICAgICAgaWYgKGhvbGlkYXkgIT0gbnVsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBTY3JpcHRSZXNwb25zZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIEtleSA9ICJwdWJsaWMtaG9saWRheSIsCiAgICAgICAgICAgICAgICAgICAgRGF0YSA9IG5ldwogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWR2aXNvcklkLAogICAgICAgICAgICAgICAgICAgICAgICBkYXRlID0gZGF0ZVN0ciwKICAgICAgICAgICAgICAgICAgICAgICAgYXBwb2ludG1lbnREdXJhdGlvbiA9IGR1cmF0aW9uLAogICAgICAgICAgICAgICAgICAgICAgICB3b3JraW5nSG91cnMgPSBuZXcgTGlzdDxvYmplY3Q+KCksCiAgICAgICAgICAgICAgICAgICAgICAgIGF2YWlsYWJsZVNsb3RzID0gbmV3IExpc3Q8c3RyaW5nPigpLAogICAgICAgICAgICAgICAgICAgICAgICBpc1B1YmxpY0hvbGlkYXkgPSB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBwdWJsaWNIb2xpZGF5TmFtZSA9IGhvbGlkYXkudGl0bGU/LlRvU3RyaW5nKCkgPz8gIlB1YmxpYyBIb2xpZGF5IgogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgVGFncyA9IG5ld1tdIHsgImFwcG9pbnRtZW50cyIsICJob2xpZGF5IiB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBHZXQgd29ya2luZyBob3VycyAoY3VzdG9tIG9yIGRlZmF1bHQgZnJvbSBjb25maWcpCiAgICAgICAgICAgIHZhciB3b3JraW5nSG91cnMgPSBHZXRXb3JraW5nSG91cnNGb3JEYXkod29ya2luZ0hvdXJzQ2hhbmdlcywgZGF5T2ZXZWVrLCByZXF1ZXN0ZWREYXRlLCBjb250ZXh0KTsKCiAgICAgICAgICAgIGlmICh3b3JraW5nSG91cnMgPT0gbnVsbCB8fCB3b3JraW5nSG91cnMuQ291bnQgPT0gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBTY3JpcHRSZXNwb25zZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIEtleSA9ICJuby13b3JraW5nLWhvdXJzIiwKICAgICAgICAgICAgICAgICAgICBEYXRhID0gbmV3CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBhZHZpc29ySWQsCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGUgPSBkYXRlU3RyLAogICAgICAgICAgICAgICAgICAgICAgICBhcHBvaW50bWVudER1cmF0aW9uID0gZHVyYXRpb24sCiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtpbmdIb3VycyA9IG5ldyBMaXN0PG9iamVjdD4oKSwKICAgICAgICAgICAgICAgICAgICAgICAgYXZhaWxhYmxlU2xvdHMgPSBuZXcgTGlzdDxzdHJpbmc+KCksCiAgICAgICAgICAgICAgICAgICAgICAgIGlzUHVibGljSG9saWRheSA9IGZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBUYWdzID0gbmV3W10geyAiYXBwb2ludG1lbnRzIiwgImNsb3NlZCIgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gR2V0IHVuYXZhaWxhYmxlIHRpbWUgcmFuZ2VzIGZyb20gcGVyc29uYWwgbGVhdmVzCiAgICAgICAgICAgIHZhciB1bmF2YWlsYWJsZVJhbmdlcyA9IEdldFVuYXZhaWxhYmxlUmFuZ2VzKHBlcnNvbmFsTGVhdmVzLCByZXF1ZXN0ZWREYXRlKTsKCiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBhdmFpbGFibGUgc2xvdHMKICAgICAgICAgICAgdmFyIGF2YWlsYWJsZVNsb3RzID0gQ2FsY3VsYXRlQXZhaWxhYmxlU2xvdHMod29ya2luZ0hvdXJzLCB1bmF2YWlsYWJsZVJhbmdlcywgZHVyYXRpb24pOwoKICAgICAgICAgICAgcmV0dXJuIG5ldyBTY3JpcHRSZXNwb25zZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBLZXkgPSAiYXZhaWxhYmxlLXNsb3RzLXN1Y2Nlc3MiLAogICAgICAgICAgICAgICAgRGF0YSA9IG5ldwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGFkdmlzb3JJZCwKICAgICAgICAgICAgICAgICAgICBkYXRlID0gZGF0ZVN0ciwKICAgICAgICAgICAgICAgICAgICBhcHBvaW50bWVudER1cmF0aW9uID0gZHVyYXRpb24sCiAgICAgICAgICAgICAgICAgICAgd29ya2luZ0hvdXJzLAogICAgICAgICAgICAgICAgICAgIGF2YWlsYWJsZVNsb3RzLAogICAgICAgICAgICAgICAgICAgIGlzUHVibGljSG9saWRheSA9IGZhbHNlCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgVGFncyA9IG5ld1tdIHsgImFwcG9pbnRtZW50cyIsICJhdmFpbGFiaWxpdHkiLCAic3VjY2VzcyIgfQogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBjYXRjaCAoRXhjZXB0aW9uIGV4KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBTY3JpcHRSZXNwb25zZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBLZXkgPSAib3V0cHV0LWVycm9yIiwKICAgICAgICAgICAgICAgIERhdGEgPSBuZXcKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBlcnJvciA9ICJJbnRlcm5hbCBwcm9jZXNzaW5nIGVycm9yIiwKICAgICAgICAgICAgICAgICAgICBlcnJvckNvZGUgPSAiUFJPQ0VTU0lOR19FUlJPUiIsCiAgICAgICAgICAgICAgICAgICAgZXJyb3JEZXNjcmlwdGlvbiA9IGV4Lk1lc3NhZ2UKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBUYWdzID0gbmV3W10geyAiYXBwb2ludG1lbnRzIiwgImVycm9yIiB9CiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgfQoKICAgICNyZWdpb24gSGVscGVyIE1ldGhvZHMKCiAgICBwcml2YXRlIHN0cmluZyBDbGFzc2lmeVNlcnZpY2VFcnJvcihzdHJpbmcgZXJyb3JNZXNzYWdlKQogICAgewogICAgICAgIGlmIChlcnJvck1lc3NhZ2UuQ29udGFpbnMoInRpbWVvdXQiLCBTdHJpbmdDb21wYXJpc29uLk9yZGluYWxJZ25vcmVDYXNlKSkKICAgICAgICAgICAgcmV0dXJuICJ0aW1lb3V0IjsKICAgICAgICBpZiAoZXJyb3JNZXNzYWdlLkNvbnRhaW5zKCJ1bmF1dGhvcml6ZWQiLCBTdHJpbmdDb21wYXJpc29uLk9yZGluYWxJZ25vcmVDYXNlKSkKICAgICAgICAgICAgcmV0dXJuICJhdXRoZW50aWNhdGlvbiI7CiAgICAgICAgaWYgKGVycm9yTWVzc2FnZS5Db250YWlucygiZm9yYmlkZGVuIiwgU3RyaW5nQ29tcGFyaXNvbi5PcmRpbmFsSWdub3JlQ2FzZSkpCiAgICAgICAgICAgIHJldHVybiAiYXV0aG9yaXphdGlvbiI7CiAgICAgICAgaWYgKGVycm9yTWVzc2FnZS5Db250YWlucygibm90IGZvdW5kIiwgU3RyaW5nQ29tcGFyaXNvbi5PcmRpbmFsSWdub3JlQ2FzZSkpCiAgICAgICAgICAgIHJldHVybiAibm90LWZvdW5kIjsKICAgICAgICBpZiAoZXJyb3JNZXNzYWdlLkNvbnRhaW5zKCJzZXJ2aWNlIHVuYXZhaWxhYmxlIiwgU3RyaW5nQ29tcGFyaXNvbi5PcmRpbmFsSWdub3JlQ2FzZSkpCiAgICAgICAgICAgIHJldHVybiAic2VydmljZS11bmF2YWlsYWJsZSI7CiAgICAgICAgaWYgKGVycm9yTWVzc2FnZS5Db250YWlucygiY29ubmVjdGlvbiIsIFN0cmluZ0NvbXBhcmlzb24uT3JkaW5hbElnbm9yZUNhc2UpKQogICAgICAgICAgICByZXR1cm4gImNvbm5lY3Rpb24tZXJyb3IiOwoKICAgICAgICByZXR1cm4gImdlbmVyYWwtZXJyb3IiOwogICAgfQoKICAgIHByaXZhdGUgYm9vbCBJc1JldHJ5YWJsZVNlcnZpY2VFcnJvcihzdHJpbmcgZXJyb3JNZXNzYWdlKQogICAgewogICAgICAgIHJldHVybiBlcnJvck1lc3NhZ2UuQ29udGFpbnMoInRpbWVvdXQiLCBTdHJpbmdDb21wYXJpc29uLk9yZGluYWxJZ25vcmVDYXNlKSB8fAogICAgICAgICAgICAgICBlcnJvck1lc3NhZ2UuQ29udGFpbnMoInNlcnZpY2UgdW5hdmFpbGFibGUiLCBTdHJpbmdDb21wYXJpc29uLk9yZGluYWxJZ25vcmVDYXNlKSB8fAogICAgICAgICAgICAgICBlcnJvck1lc3NhZ2UuQ29udGFpbnMoImNvbm5lY3Rpb24iLCBTdHJpbmdDb21wYXJpc29uLk9yZGluYWxJZ25vcmVDYXNlKTsKICAgIH0KCiAgICAjZW5kcmVnaW9uCgogICAgI3JlZ2lvbiBCdXNpbmVzcyBMb2dpYyBNZXRob2RzCgogICAgcHJpdmF0ZSBkeW5hbWljIEZpbmRQdWJsaWNIb2xpZGF5KExpc3Q8ZHluYW1pYz4gaG9saWRheXMsIERhdGVUaW1lIGRhdGUpCiAgICB7CiAgICAgICAgZm9yZWFjaCAodmFyIGhvbGlkYXkgaW4gaG9saWRheXMpCiAgICAgICAgewogICAgICAgICAgICAvLyBJbnN0YW5jZSBzdHJ1Y3R1cmU6IHsgYXR0cmlidXRlczogey4uLn0gfQogICAgICAgICAgICB2YXIgaG9saWRheURhdGEgPSBob2xpZGF5Py5hdHRyaWJ1dGVzOwogICAgICAgICAgICBpZiAoaG9saWRheURhdGEgPT0gbnVsbCkgY29udGludWU7CgogICAgICAgICAgICB2YXIgZW50cnlNb2RlID0gaG9saWRheURhdGE/LmVudHJ5TW9kZT8uVG9TdHJpbmcoKTsKCiAgICAgICAgICAgIGlmIChlbnRyeU1vZGUgPT0gImZ1bGwtZGF5IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHN0YXJ0RGF0ZVN0ciA9IGhvbGlkYXlEYXRhPy5zdGFydERhdGU/LlRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICB2YXIgZW5kRGF0ZVN0ciA9IGhvbGlkYXlEYXRhPy5lbmREYXRlPy5Ub1N0cmluZygpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoIXN0cmluZy5Jc051bGxPckVtcHR5KHN0YXJ0RGF0ZVN0cikgJiYgIXN0cmluZy5Jc051bGxPckVtcHR5KGVuZERhdGVTdHIpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciBzdGFydERhdGUgPSBEYXRlVGltZS5QYXJzZShzdGFydERhdGVTdHIpOwogICAgICAgICAgICAgICAgICAgIHZhciBlbmREYXRlID0gRGF0ZVRpbWUuUGFyc2UoZW5kRGF0ZVN0cik7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGUuRGF0ZSA+PSBzdGFydERhdGUuRGF0ZSAmJiBkYXRlLkRhdGUgPD0gZW5kRGF0ZS5EYXRlKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaG9saWRheURhdGE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoZW50cnlNb2RlID09ICJ0aW1lLXJhbmdlIikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHN0YXJ0RGF0ZVRpbWVTdHIgPSBob2xpZGF5RGF0YT8uc3RhcnREYXRlVGltZT8uVG9TdHJpbmcoKTsKICAgICAgICAgICAgICAgIHZhciBlbmREYXRlVGltZVN0ciA9IGhvbGlkYXlEYXRhPy5lbmREYXRlVGltZT8uVG9TdHJpbmcoKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKCFzdHJpbmcuSXNOdWxsT3JFbXB0eShzdGFydERhdGVUaW1lU3RyKSAmJiAhc3RyaW5nLklzTnVsbE9yRW1wdHkoZW5kRGF0ZVRpbWVTdHIpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciBzdGFydERhdGVUaW1lID0gRGF0ZVRpbWUuUGFyc2Uoc3RhcnREYXRlVGltZVN0cik7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVuZERhdGVUaW1lID0gRGF0ZVRpbWUuUGFyc2UoZW5kRGF0ZVRpbWVTdHIpOwogICAgICAgICAgICAgICAgICAgIGlmIChkYXRlLkRhdGUgPj0gc3RhcnREYXRlVGltZS5EYXRlICYmIGRhdGUuRGF0ZSA8PSBlbmREYXRlVGltZS5EYXRlKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaG9saWRheURhdGE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgcHJpdmF0ZSBMaXN0PG9iamVjdD4gR2V0V29ya2luZ0hvdXJzRm9yRGF5KExpc3Q8ZHluYW1pYz4gd29ya2luZ0hvdXJzQ2hhbmdlcywgc3RyaW5nIGRheU9mV2VlaywgRGF0ZVRpbWUgZGF0ZSwgU2NyaXB0Q29udGV4dCBjb250ZXh0KQogICAgewogICAgICAgIC8vIENoZWNrIGZvciBjdXN0b20gd29ya2luZyBob3VycwogICAgICAgIGZvcmVhY2ggKHZhciBjaGFuZ2UgaW4gd29ya2luZ0hvdXJzQ2hhbmdlcykKICAgICAgICB7CiAgICAgICAgICAgIC8vIEluc3RhbmNlIHN0cnVjdHVyZTogeyBhdHRyaWJ1dGVzOiB7Li4ufSB9CiAgICAgICAgICAgIHZhciBjaGFuZ2VEYXRhID0gY2hhbmdlPy5hdHRyaWJ1dGVzOwogICAgICAgICAgICBpZiAoY2hhbmdlRGF0YSA9PSBudWxsKSBjb250aW51ZTsKCiAgICAgICAgICAgIHZhciBjdXN0b21XSCA9IGNoYW5nZURhdGE/LmN1c3RvbVdvcmtpbmdIb3VyczsKICAgICAgICAgICAgaWYgKGN1c3RvbVdIID09IG51bGwpIGNvbnRpbnVlOwoKICAgICAgICAgICAgdmFyIGVmZmVjdGl2ZUZyb21TdHIgPSBjdXN0b21XSD8uZWZmZWN0aXZlRnJvbT8uVG9TdHJpbmcoKTsKICAgICAgICAgICAgdmFyIGVmZmVjdGl2ZVRvU3RyID0gY3VzdG9tV0g/LmVmZmVjdGl2ZVRvPy5Ub1N0cmluZygpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHN0cmluZy5Jc051bGxPckVtcHR5KGVmZmVjdGl2ZUZyb21TdHIpKSBjb250aW51ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciBlZmZlY3RpdmVGcm9tID0gRGF0ZVRpbWUuUGFyc2UoZWZmZWN0aXZlRnJvbVN0cik7CiAgICAgICAgICAgIHZhciBlZmZlY3RpdmVUbyA9IHN0cmluZy5Jc051bGxPckVtcHR5KGVmZmVjdGl2ZVRvU3RyKSA/IERhdGVUaW1lLk1heFZhbHVlIDogRGF0ZVRpbWUuUGFyc2UoZWZmZWN0aXZlVG9TdHIpOwoKICAgICAgICAgICAgaWYgKGRhdGUuRGF0ZSA+PSBlZmZlY3RpdmVGcm9tLkRhdGUgJiYgZGF0ZS5EYXRlIDw9IGVmZmVjdGl2ZVRvLkRhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBkYXlIb3VycyA9IEdldERheUhvdXJzRnJvbUN1c3RvbShjdXN0b21XSCwgZGF5T2ZXZWVrKTsKICAgICAgICAgICAgICAgIGlmIChkYXlIb3VycyAhPSBudWxsKSByZXR1cm4gZGF5SG91cnM7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFJldHVybiBkZWZhdWx0IHdvcmtpbmcgaG91cnMgZnJvbSBjb25maWcKICAgICAgICByZXR1cm4gR2V0RGVmYXVsdFdvcmtpbmdIb3VycyhkYXlPZldlZWssIGNvbnRleHQpOwogICAgfQoKICAgIHByaXZhdGUgTGlzdDxvYmplY3Q+IEdldERheUhvdXJzRnJvbUN1c3RvbShkeW5hbWljIGN1c3RvbVdILCBzdHJpbmcgZGF5T2ZXZWVrKQogICAgewogICAgICAgIGR5bmFtaWMgZGF5SG91cnMgPSBudWxsOwogICAgICAgIHN3aXRjaCAoZGF5T2ZXZWVrKQogICAgICAgIHsKICAgICAgICAgICAgY2FzZSAibW9uZGF5IjogZGF5SG91cnMgPSBjdXN0b21XSD8ubW9uZGF5OyBicmVhazsKICAgICAgICAgICAgY2FzZSAidHVlc2RheSI6IGRheUhvdXJzID0gY3VzdG9tV0g/LnR1ZXNkYXk7IGJyZWFrOwogICAgICAgICAgICBjYXNlICJ3ZWRuZXNkYXkiOiBkYXlIb3VycyA9IGN1c3RvbVdIPy53ZWRuZXNkYXk7IGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0aHVyc2RheSI6IGRheUhvdXJzID0gY3VzdG9tV0g/LnRodXJzZGF5OyBicmVhazsKICAgICAgICAgICAgY2FzZSAiZnJpZGF5IjogZGF5SG91cnMgPSBjdXN0b21XSD8uZnJpZGF5OyBicmVhazsKICAgICAgICAgICAgY2FzZSAic2F0dXJkYXkiOiBkYXlIb3VycyA9IGN1c3RvbVdIPy5zYXR1cmRheTsgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInN1bmRheSI6IGRheUhvdXJzID0gY3VzdG9tV0g/LnN1bmRheTsgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICBpZiAoZGF5SG91cnMgPT0gbnVsbCkgcmV0dXJuIG51bGw7CgogICAgICAgIHZhciByZXN1bHQgPSBuZXcgTGlzdDxvYmplY3Q+KCk7CiAgICAgICAgZm9yZWFjaCAodmFyIHJhbmdlIGluIGRheUhvdXJzKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHN0YXJ0ID0gcmFuZ2U/LnN0YXJ0Py5Ub1N0cmluZygpOwogICAgICAgICAgICB2YXIgZW5kID0gcmFuZ2U/LmVuZD8uVG9TdHJpbmcoKTsKICAgICAgICAgICAgaWYgKCFzdHJpbmcuSXNOdWxsT3JFbXB0eShzdGFydCkgJiYgIXN0cmluZy5Jc051bGxPckVtcHR5KGVuZCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJlc3VsdC5BZGQobmV3IHsgc3RhcnQsIGVuZCB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0LkNvdW50ID4gMCA/IHJlc3VsdCA6IG51bGw7CiAgICB9CgogICAgcHJpdmF0ZSBMaXN0PG9iamVjdD4gR2V0RGVmYXVsdFdvcmtpbmdIb3VycyhzdHJpbmcgZGF5T2ZXZWVrLCBTY3JpcHRDb250ZXh0IGNvbnRleHQpCiAgICB7CiAgICAgICAgLy8gR2V0IGZyb20gYXBwc2V0dGluZ3MuanNvbiBjb25maWd1cmF0aW9uIHVzaW5nIEdldENvbmZpZ1ZhbHVlCiAgICAgICAgLy8gQ29uZmlnIGtleSBmb3JtYXQ6ICJXb3JraW5nSG91cnM6TW9uZGF5IiA9ICIwOTowMC0xMjowMCwxMzozMC0xODowMCIKICAgICAgICB2YXIgZGF5S2V5ID0gY2hhci5Ub1VwcGVyKGRheU9mV2Vla1swXSkgKyBkYXlPZldlZWsuU3Vic3RyaW5nKDEpOyAvLyBtb25kYXkgLT4gTW9uZGF5CiAgICAgICAgdmFyIGNvbmZpZ0tleSA9ICQiV29ya2luZ0hvdXJzOntkYXlLZXl9IjsKICAgICAgICB2YXIgY29uZmlnVmFsdWUgPSBHZXRDb25maWdWYWx1ZShjb25maWdLZXkpOwoKICAgICAgICBpZiAoIXN0cmluZy5Jc051bGxPckVtcHR5KGNvbmZpZ1ZhbHVlKSkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBjb25maWdIb3VycyA9IFBhcnNlV29ya2luZ0hvdXJzQ29uZmlnKGNvbmZpZ1ZhbHVlKTsKICAgICAgICAgICAgaWYgKGNvbmZpZ0hvdXJzICE9IG51bGwgJiYgY29uZmlnSG91cnMuQ291bnQgPiAwKSByZXR1cm4gY29uZmlnSG91cnM7CiAgICAgICAgfQoKICAgICAgICAvLyBEZWZhdWx0IHdvcmtpbmcgaG91cnMgaWYgbm90IGNvbmZpZ3VyZWQKICAgICAgICBpZiAoZGF5T2ZXZWVrID09ICJzYXR1cmRheSIgfHwgZGF5T2ZXZWVrID09ICJzdW5kYXkiKQogICAgICAgICAgICByZXR1cm4gbmV3IExpc3Q8b2JqZWN0PigpOwoKICAgICAgICByZXR1cm4gbmV3IExpc3Q8b2JqZWN0PgogICAgICAgIHsKICAgICAgICAgICAgbmV3IHsgc3RhcnQgPSAiMDk6MDAiLCBlbmQgPSAiMTI6MDAiIH0sCiAgICAgICAgICAgIG5ldyB7IHN0YXJ0ID0gIjEzOjMwIiwgZW5kID0gIjE4OjAwIiB9CiAgICAgICAgfTsKICAgIH0KCiAgICBwcml2YXRlIExpc3Q8b2JqZWN0PiBQYXJzZVdvcmtpbmdIb3Vyc0NvbmZpZyhzdHJpbmcgY29uZmlnVmFsdWUpCiAgICB7CiAgICAgICAgLy8gUGFyc2UgY29uZmlnIHZhbHVlIGZvcm1hdDogIjA5OjAwLTEyOjAwLDEzOjMwLTE4OjAwIgogICAgICAgIHZhciByZXN1bHQgPSBuZXcgTGlzdDxvYmplY3Q+KCk7CiAgICAgICAgCiAgICAgICAgaWYgKHN0cmluZy5Jc051bGxPckVtcHR5KGNvbmZpZ1ZhbHVlKSkKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKCiAgICAgICAgdmFyIHJhbmdlcyA9IGNvbmZpZ1ZhbHVlLlNwbGl0KCcsJyk7CiAgICAgICAgZm9yZWFjaCAodmFyIHJhbmdlIGluIHJhbmdlcykKICAgICAgICB7CiAgICAgICAgICAgIHZhciB0cmltbWVkID0gcmFuZ2UuVHJpbSgpOwogICAgICAgICAgICBpZiAoc3RyaW5nLklzTnVsbE9yRW1wdHkodHJpbW1lZCkpIGNvbnRpbnVlOwoKICAgICAgICAgICAgdmFyIHBhcnRzID0gdHJpbW1lZC5TcGxpdCgnLScpOwogICAgICAgICAgICBpZiAocGFydHMuTGVuZ3RoID09IDIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBzdGFydCA9IHBhcnRzWzBdLlRyaW0oKTsKICAgICAgICAgICAgICAgIHZhciBlbmQgPSBwYXJ0c1sxXS5UcmltKCk7CiAgICAgICAgICAgICAgICBpZiAoIXN0cmluZy5Jc051bGxPckVtcHR5KHN0YXJ0KSAmJiAhc3RyaW5nLklzTnVsbE9yRW1wdHkoZW5kKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHQuQWRkKG5ldyB7IHN0YXJ0LCBlbmQgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICBwcml2YXRlIExpc3Q8KFRpbWVTcGFuIFN0YXJ0LCBUaW1lU3BhbiBFbmQpPiBHZXRVbmF2YWlsYWJsZVJhbmdlcyhMaXN0PGR5bmFtaWM+IHBlcnNvbmFsTGVhdmVzLCBEYXRlVGltZSBkYXRlKQogICAgewogICAgICAgIHZhciByYW5nZXMgPSBuZXcgTGlzdDwoVGltZVNwYW4gU3RhcnQsIFRpbWVTcGFuIEVuZCk+KCk7CgogICAgICAgIGZvcmVhY2ggKHZhciBsZWF2ZSBpbiBwZXJzb25hbExlYXZlcykKICAgICAgICB7CiAgICAgICAgICAgIC8vIEluc3RhbmNlIHN0cnVjdHVyZTogeyBhdHRyaWJ1dGVzOiB7Li4ufSB9CiAgICAgICAgICAgIHZhciBsZWF2ZURhdGEgPSBsZWF2ZT8uYXR0cmlidXRlczsKICAgICAgICAgICAgaWYgKGxlYXZlRGF0YSA9PSBudWxsKSBjb250aW51ZTsKCiAgICAgICAgICAgIHZhciBlbnRyeU1vZGUgPSBsZWF2ZURhdGE/LmVudHJ5TW9kZT8uVG9TdHJpbmcoKTsKCiAgICAgICAgICAgIGlmIChlbnRyeU1vZGUgPT0gImZ1bGwtZGF5IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHN0YXJ0RGF0ZVN0ciA9IGxlYXZlRGF0YT8uc3RhcnREYXRlPy5Ub1N0cmluZygpOwogICAgICAgICAgICAgICAgdmFyIGVuZERhdGVTdHIgPSBsZWF2ZURhdGE/LmVuZERhdGU/LlRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICghc3RyaW5nLklzTnVsbE9yRW1wdHkoc3RhcnREYXRlU3RyKSAmJiAhc3RyaW5nLklzTnVsbE9yRW1wdHkoZW5kRGF0ZVN0cikpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXJ0RGF0ZSA9IERhdGVUaW1lLlBhcnNlKHN0YXJ0RGF0ZVN0cik7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVuZERhdGUgPSBEYXRlVGltZS5QYXJzZShlbmREYXRlU3RyKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZGF0ZS5EYXRlID49IHN0YXJ0RGF0ZS5EYXRlICYmIGRhdGUuRGF0ZSA8PSBlbmREYXRlLkRhdGUpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICByYW5nZXMuQWRkKChUaW1lU3Bhbi5aZXJvLCBuZXcgVGltZVNwYW4oMjMsIDU5LCA1OSkpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoZW50cnlNb2RlID09ICJ0aW1lLXJhbmdlIikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHN0YXJ0RGF0ZVRpbWVTdHIgPSBsZWF2ZURhdGE/LnN0YXJ0RGF0ZVRpbWU/LlRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICB2YXIgZW5kRGF0ZVRpbWVTdHIgPSBsZWF2ZURhdGE/LmVuZERhdGVUaW1lPy5Ub1N0cmluZygpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoIXN0cmluZy5Jc051bGxPckVtcHR5KHN0YXJ0RGF0ZVRpbWVTdHIpICYmICFzdHJpbmcuSXNOdWxsT3JFbXB0eShlbmREYXRlVGltZVN0cikpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXJ0RGF0ZVRpbWUgPSBEYXRlVGltZS5QYXJzZShzdGFydERhdGVUaW1lU3RyKTsKICAgICAgICAgICAgICAgICAgICB2YXIgZW5kRGF0ZVRpbWUgPSBEYXRlVGltZS5QYXJzZShlbmREYXRlVGltZVN0cik7CgogICAgICAgICAgICAgICAgICAgIGlmIChzdGFydERhdGVUaW1lLkRhdGUgPT0gZGF0ZS5EYXRlKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXJ0VGltZSA9IHN0YXJ0RGF0ZVRpbWUuVGltZU9mRGF5OwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZW5kVGltZSA9IGVuZERhdGVUaW1lLkRhdGUgPT0gZGF0ZS5EYXRlID8gZW5kRGF0ZVRpbWUuVGltZU9mRGF5IDogbmV3IFRpbWVTcGFuKDIzLCA1OSwgNTkpOwogICAgICAgICAgICAgICAgICAgICAgICByYW5nZXMuQWRkKChzdGFydFRpbWUsIGVuZFRpbWUpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiByYW5nZXM7CiAgICB9CgogICAgcHJpdmF0ZSBMaXN0PHN0cmluZz4gQ2FsY3VsYXRlQXZhaWxhYmxlU2xvdHMoTGlzdDxvYmplY3Q+IHdvcmtpbmdIb3VycywgTGlzdDwoVGltZVNwYW4gU3RhcnQsIFRpbWVTcGFuIEVuZCk+IHVuYXZhaWxhYmxlUmFuZ2VzLCBpbnQgZHVyYXRpb25NaW51dGVzKQogICAgewogICAgICAgIHZhciBzbG90cyA9IG5ldyBMaXN0PHN0cmluZz4oKTsKICAgICAgICB2YXIgZHVyYXRpb24gPSBUaW1lU3Bhbi5Gcm9tTWludXRlcyhkdXJhdGlvbk1pbnV0ZXMpOwoKICAgICAgICBmb3JlYWNoICh2YXIgd2ggaW4gd29ya2luZ0hvdXJzKQogICAgICAgIHsKICAgICAgICAgICAgZHluYW1pYyB3aER5biA9IHdoOwogICAgICAgICAgICB2YXIgc3RhcnRTdHIgPSB3aER5bj8uc3RhcnQ/LlRvU3RyaW5nKCk7CiAgICAgICAgICAgIHZhciBlbmRTdHIgPSB3aER5bj8uZW5kPy5Ub1N0cmluZygpOwoKICAgICAgICAgICAgaWYgKHN0cmluZy5Jc051bGxPckVtcHR5KHN0YXJ0U3RyKSB8fCBzdHJpbmcuSXNOdWxsT3JFbXB0eShlbmRTdHIpKQogICAgICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgICB2YXIgd2hTdGFydCA9IFRpbWVTcGFuLlBhcnNlKHN0YXJ0U3RyKTsKICAgICAgICAgICAgdmFyIHdoRW5kID0gVGltZVNwYW4uUGFyc2UoZW5kU3RyKTsKCiAgICAgICAgICAgIC8vIFNraXAgaWYgc3RhcnQgPT0gZW5kIChjbG9zZWQpCiAgICAgICAgICAgIGlmICh3aFN0YXJ0ID09IHdoRW5kKQogICAgICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgICB2YXIgY3VycmVudCA9IHdoU3RhcnQ7CiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50ICsgZHVyYXRpb24gPD0gd2hFbmQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBzbG90U3RhcnQgPSBjdXJyZW50OwogICAgICAgICAgICAgICAgdmFyIHNsb3RFbmQgPSBjdXJyZW50ICsgZHVyYXRpb247CgogICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgc2xvdCBvdmVybGFwcyB3aXRoIGFueSB1bmF2YWlsYWJsZSByYW5nZQogICAgICAgICAgICAgICAgYm9vbCBpc0F2YWlsYWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICBmb3JlYWNoICh2YXIgdXIgaW4gdW5hdmFpbGFibGVSYW5nZXMpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNsb3RTdGFydCA8IHVyLkVuZCAmJiBzbG90RW5kID4gdXIuU3RhcnQpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBpc0F2YWlsYWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGlzQXZhaWxhYmxlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHNsb3RzLkFkZCgkIntzbG90U3RhcnQ6aGhcXDptbX0te3Nsb3RFbmQ6aGhcXDptbX0iKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjdXJyZW50ID0gY3VycmVudCArIGR1cmF0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc2xvdHM7CiAgICB9CgogICAgI2VuZHJlZ2lvbgp9Cg=="
      }
    }
  }
}